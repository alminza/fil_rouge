user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}



http {
	#include       /etc/nginx/mime.types;
    	default_type  application/octet-stream;
	sendfile        on;

	server {
    		listen 80;
    		server_name fil-rouge.vdp.p2021.ajoga.fr;
		location /.well-known/acme-challenge/ {
                        root /var/www/certbot;
        	}    		
		location / {
        		proxy_pass http://loadbalancer;
    	}  
    
	}
	upstream loadbalancer { #Permet d'effectuer le load-balancing en local, maximum 6 réplications du serveur flask entre les ports 5001 à 5006 facilement extensible
        	server 172.31.23.96:5001;
        	server 172.31.23.96:5002;
        	server 172.31.23.96:5003;
        	server 172.31.23.96:5004;
        	server 172.31.23.96:5005;
        	server 172.31.23.96:5006;
        	}
	server {
    		listen 443 ssl;
    		server_name fil-rouge.vdp.p2021.ajoga.fr;
    		ssl_certificate /etc/letsencrypt/live/fil-rouge.vdp.p2021.ajoga.fr/fullchain.pem;
    		ssl_certificate_key /etc/letsencrypt/live/fil-rouge.vdp.p2021.ajoga.fr/privkey.pem;
    
    		include /etc/letsencrypt/options-ssl-nginx.conf;
    		ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    		location /{
			proxy_pass http://loadbalancer;
    		}
	}
}
